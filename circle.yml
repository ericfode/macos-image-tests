machine:
  environment:
    GIT_DEPLOY_USERNAME: deploy_bot
    GIT_DEPLOY_EMAIL:    deploy@circleci.com
    GIT_DEPLOY_DIR:      pages/_site
    GIT_DEPLOY_BRANCH:   gh-pages
  xcode:
    version: 8.3.2

general:
  artifacts:
    - pages/_site

dependencies:
  pre:
    - brew install jq
    - sudo pip install jsonschema
test:
  override:
    - ./software_versions.rb > $CIRCLE_ARTIFACTS/software_versions.json
    - bundle exec rspec:
        environment:
          SOFTWARE: $CIRCLE_ARTIFACTS/software_versions.json
    - jsonschema -i $CIRCLE_ARTIFACTS/software_versions.json software_versions.schema.json
    - bundle exec jekyll build:
        pwd: pages
    - jq '.image.sha1' software_versions.json

deployment:
  publish:
    branch: master
    commands:
      - scripts/deploy.sh
